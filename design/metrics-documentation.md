# CEL Policy Evaluation Metrics Documentation

## Overview

This document describes the comprehensive metrics implemented for the CEL-based IP restriction policy evaluation system in the authenticator-intake service.

## Metrics

### 1. Policy Evaluation Metric
**Name:** `dd.authenticator.intake.policy.evaluation`

**Description:** Tracks the overall outcome of policy evaluations at the policy engine level.

**Tags:**
- `decision`: `allow` | `deny` | `error` - The evaluation result
- `reason`: Snake-cased reason string (e.g., `policy_allows_access`, `policy_blocks_access`, `no_restriction_policies_configured`)
- `mode`: `disabled` | `dry_run` | `enforced` - Policy enforcement mode
- `policy_type`: `key_specific` | `org_wide` - Whether policy is API key-specific or organization-wide
- `policy_scope`: `key_specific` | `org_wide` - Scope of the applied policy
- `error`: `true` | `false` - Whether an error occurred

**Usage Example:**
```
sum:dd.authenticator.intake.policy.evaluation{decision:deny} by {reason}
```

### 2. Policy Cache Metric
**Name:** `dd.authenticator.intake.policy.cache`

**Description:** Monitors cache operations for compiled CEL policies.

**Tags:**
- `operation`: `hit` | `miss` | `update` - Cache operation type
- `policy_type`: `key_specific` | `org_wide` - Type of policy being cached

**Usage Example:**
```
# Cache hit rate
sum:dd.authenticator.intake.policy.cache{operation:hit} /
(sum:dd.authenticator.intake.policy.cache{operation:hit} + sum:dd.authenticator.intake.policy.cache{operation:miss})
```

### 3. Policy Fetch Metric
**Name:** `dd.authenticator.intake.policy.fetch`

**Description:** Tracks FRAMES fetch operations for restriction policies.

**Tags:**
- `result`: `success` | `failure` | `not_found` - Fetch operation result
- `policy_type`: `key_specific` | `org_wide` - Type of policy being fetched

**Usage Example:**
```
sum:dd.authenticator.intake.policy.fetch{result:failure} by {policy_type}
```

### 4. Policy Decision Metric
**Name:** `dd.authenticator.intake.policy.decision`

**Description:** Tracks final authorization decisions at the request handler level.

**Tags:**
- `decision`: `allow` | `deny` - Final decision
- `reason`: Snake-cased reason (automatically converted from decision.Reason)
- `mode`: `disabled` | `dry_run` | `enforced` - Policy mode
- `product`: `logs` | `metrics` | `apm` | etc. - Product making the request

**Usage Example:**
```
# Denial rate by product
sum:dd.authenticator.intake.policy.decision{decision:deny} by {product}

# Dry-run would-block detection
sum:dd.authenticator.intake.policy.decision{mode:dry_run,reason:dry_run_would_have_blocked_access}
```

## Reason Tag Values

The `reason` tag is automatically generated by converting the decision reason to snake_case. Common values include:

- `policy_allows_access` - Policy evaluated and allowed the request
- `policy_blocks_access` - Policy evaluated and denied the request
- `no_restriction_policies_configured` - No policies found for org/key
- `policy_is_disabled` - Policy exists but is disabled
- `dry_run_would_have_allowed_access` - Dry-run mode, would allow
- `dry_run_would_have_blocked_access` - Dry-run mode, would block
- `policy_evaluation_error_*` - Various evaluation errors
- `policy_evaluation_returned_non_boolean_result` - CEL returned non-boolean
- `fail_open` - Error occurred, failing open for availability
- `no_policy` - No policy configured

## Logging

Structured logging has been added at appropriate levels:

### Info Level
- Policy evaluation completion with decision
- Policy compilation success
- Cache operations
- Policy fetch operations

### Warning Level
- Policy compilation issues
- Unknown policy modes
- Invalid configurations

### Error Level
- FRAMES fetch failures
- CEL compilation failures
- CEL evaluation errors
- Marshal/unmarshal errors

## Dashboard Queries

### Policy Effectiveness
```datadog
# Block rate by policy type
sum:dd.authenticator.intake.policy.decision{decision:deny} by {policy_type}

# Policy evaluation errors
sum:dd.authenticator.intake.policy.evaluation{error:true} by {reason}
```

### Performance Monitoring
```datadog
# Cache hit rate
sum:dd.authenticator.intake.policy.cache{operation:hit}.as_rate() /
(sum:dd.authenticator.intake.policy.cache{operation:hit}.as_rate() +
 sum:dd.authenticator.intake.policy.cache{operation:miss}.as_rate())

# FRAMES fetch success rate
sum:dd.authenticator.intake.policy.fetch{result:success}.as_rate() /
sum:dd.authenticator.intake.policy.fetch{*}.as_rate()
```

### Dry-Run Analysis
```datadog
# Would-block rate in dry-run mode
sum:dd.authenticator.intake.policy.decision{reason:dry_run_would_have_blocked_access}.as_count()

# Compare dry-run would-block vs actual blocks
a: sum:dd.authenticator.intake.policy.decision{mode:dry_run,reason:dry_run_would_have_blocked_access}.as_rate()
b: sum:dd.authenticator.intake.policy.decision{mode:enforced,decision:deny}.as_rate()
```

### Error Monitoring
```datadog
# Fail-open rate (errors causing allow)
sum:dd.authenticator.intake.policy.decision{reason:fail_open}.as_rate()

# Policy evaluation error breakdown
sum:dd.authenticator.intake.policy.evaluation{error:true} by {reason}
```

## Implementation Notes

1. **Automatic Reason Tagging**: The `reason` field from AccessDecision is automatically converted to snake_case for metric tags using `strings.ToLower(strings.ReplaceAll(reason, " ", "_"))`

2. **Fail-Open Behavior**: All errors result in allowing the request to maintain availability. These are tracked separately with `reason:fail_open` to distinguish from legitimate allows.

3. **Dry-Run Visibility**: Dry-run mode always allows requests but tracks what would have happened with specific reason tags for analysis.

4. **Product-Level Tracking**: All decision metrics include product tags for service-specific analysis.

5. **Cache Efficiency**: Cache metrics help optimize memory usage and performance by monitoring hit rates.

## Monitors

Recommended monitors to set up:

1. **High Denial Rate Alert**
   ```
   sum(last_5m):sum:dd.authenticator.intake.policy.decision{decision:deny}.as_rate() > 0.1
   ```

2. **Policy Evaluation Errors**
   ```
   sum(last_5m):sum:dd.authenticator.intake.policy.evaluation{error:true}.as_count() > 100
   ```

3. **Low Cache Hit Rate**
   ```
   avg(last_15m):(sum:dd.authenticator.intake.policy.cache{operation:hit}.as_rate() /
   (sum:dd.authenticator.intake.policy.cache{operation:hit}.as_rate() +
    sum:dd.authenticator.intake.policy.cache{operation:miss}.as_rate())) < 0.8
   ```

4. **FRAMES Fetch Failures**
   ```
   sum(last_5m):sum:dd.authenticator.intake.policy.fetch{result:failure}.as_count() > 50
   ```

## Testing

To verify metrics are working correctly:

1. **Test Allow Case**: Send request from allowed IP, verify `decision:allow` metric
2. **Test Deny Case**: Send request from blocked IP, verify `decision:deny` metric
3. **Test Dry-Run**: Configure dry-run policy, verify `mode:dry_run` metrics
4. **Test No Policy**: Remove all policies, verify `reason:no_policy` metric
5. **Test Cache**: Make repeated requests, verify cache hit metrics increase
6. **Test Error Case**: Cause FRAMES unavailability, verify `reason:fail_open` metric